name: Dependency Security Check

on:
  # æ¯å‘¨æ—¥UTC 00:00è¿è¡Œ
  schedule:
    - cron: '0 0 * * 0'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # PRè§¦å‘
  pull_request:
    paths:
      - 'backend/requirements.txt'
      - 'backend/requirements.lock'
      - 'frontend/package.json'
      - 'frontend/package-lock.json'

jobs:
  python-security:
    name: Pythonä¾èµ–å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ è®¾ç½®Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          cd backend
          pip install -r requirements.txt

      - name: ðŸ”’ å®‰è£…Safety
        run: pip install safety

      - name: ðŸ›¡ï¸ è¿è¡Œå®‰å…¨æ£€æŸ¥
        run: |
          cd backend
          # æ£€æŸ¥å·²çŸ¥çš„å®‰å…¨æ¼æ´ž
          safety check --json --output safety-report.json || true

          # æ˜¾ç¤ºæŠ¥å‘Š
          if [ -f safety-report.json ]; then
            echo "## Safetyå®‰å…¨æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat safety-report.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰ä¸¥é‡æ¼æ´ž
          safety check --continue-on-error
        continue-on-error: true

      - name: ðŸ“Š ç”Ÿæˆä¾èµ–æŠ¥å‘Š
        run: |
          cd backend
          pip install pip-audit

          # è¿è¡Œpip-audit
          pip-audit --format json --output pip-audit-report.json || true

          # æ˜¾ç¤ºç»“æžœ
          if [ -f pip-audit-report.json ]; then
            echo "## pip-auditæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat pip-audit-report.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: ðŸ” æ£€æŸ¥ä¾èµ–ç‰ˆæœ¬ä¸€è‡´æ€§
        run: |
          cd backend

          echo "## ä¾èµ–ç‰ˆæœ¬æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥requirements.txtå’Œrequirements.lockçš„ä¸€è‡´æ€§
          python3 -c "
          import re
          from pathlib import Path

          # è¯»å–requirements.txt
          req_txt = Path('requirements.txt').read_text()
          req_lock = Path('requirements.lock').read_text() if Path('requirements.lock').exists() else ''

          # æå–åŒ…å
          packages = set(re.findall(r'^([a-zA-Z0-9_-]+)', req_txt, re.MULTILINE))
          packages.discard('AI')

          print(f'### åŒ…ç»Ÿè®¡')
          print(f'- requirements.txtä¸­å®šä¹‰çš„åŒ…: {len(packages)}')

          if req_lock:
              locked_packages = set(re.findall(r'^([a-zA-Z0-9_-]+)==', req_lock, re.MULTILINE))
              print(f'- requirements.lockä¸­é”å®šçš„åŒ…: {len(locked_packages)}')
              print(f'- æ€»é”å®šåŒ…ï¼ˆå«ä¾èµ–ï¼‰: {len([line for line in req_lock.split(\"\\n\") if \"==\" in line])}')
          else:
              print('- âš ï¸ requirements.lockä¸å­˜åœ¨')
          "

      - name: ðŸ“¤ ä¸Šä¼ æ£€æŸ¥æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: python-security-reports
          path: |
            backend/safety-report.json
            backend/pip-audit-report.json
          retention-days: 30

  node-security:
    name: Nodeä¾èµ–å®‰å…¨æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸŸ¢ è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¦ å®‰è£…ä¾èµ–
        run: |
          cd frontend
          npm ci

      - name: ðŸ”’ è¿è¡Œå®‰å…¨å®¡è®¡
        run: |
          cd frontend

          echo "## npm auditæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY

          # ç”Ÿæˆå®¡è®¡æŠ¥å‘Š
          npm audit --json > npm-audit-report.json || true

          # æ˜¾ç¤ºé«˜å±æ¼æ´žæ•°é‡
          if [ -f npm-audit-report.json ]; then
            VULN_HIGH=$(cat npm-audit-report.json | jq -r '.metadata.vulnerabilities.high // 0')
            VULN_CRITICAL=$(cat npm-audit-report.json | jq -r '.metadata.vulnerabilities.critical // 0')

            echo "### æ¼æ´žç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸ”´ é«˜å±: $VULN_HIGH" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸš¨ ä¸¥é‡: $VULN_CRITICAL" >> $GITHUB_STEP_SUMMARY

            # å¦‚æžœæœ‰é«˜å±æˆ–ä¸¥é‡æ¼æ´žï¼Œæ˜¾ç¤ºè¯¦æƒ…
            if [ "$VULN_HIGH" -gt 0 ] || [ "$VULN_CRITICAL" -gt 0 ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### æ¼æ´žè¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
              npm audit --audit-level=high >> $GITHUB_STEP_SUMMARY || true
            else
              echo "### âœ… æœªå‘çŽ°é«˜å±æˆ–ä¸¥é‡æ¼æ´ž" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # å°è¯•è‡ªåŠ¨ä¿®å¤
          echo "### è‡ªåŠ¨ä¿®å¤å°è¯•" >> $GITHUB_STEP_SUMMARY
          npm audit fix --dry-run >> $GITHUB_STEP_SUMMARY || true
        continue-on-error: true

      - name: ðŸ” æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–
        run: |
          cd frontend

          echo "## è¿‡æ—¶çš„ä¾èµ–" >> $GITHUB_STEP_SUMMARY
          npm outdated --json > npm-outdated.json || true

          if [ -s npm-outdated.json ]; then
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat npm-outdated.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… æ‰€æœ‰ä¾èµ–éƒ½æ˜¯æœ€æ–°ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: ðŸ“Š ä¾èµ–ç»Ÿè®¡
        run: |
          cd frontend

          echo "## ä¾èµ–ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY

          # ç»Ÿè®¡dependenciesæ•°é‡
          DEPS_COUNT=$(cat package.json | jq '.dependencies | length')
          DEV_DEPS_COUNT=$(cat package.json | jq '.devDependencies | length')

          echo "- ä¾èµ–: $DEPS_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- å¼€å‘ä¾èµ–: $DEV_DEPS_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- æ€»è®¡: $((DEPS_COUNT + DEV_DEPS_COUNT))" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¤ ä¸Šä¼ æ£€æŸ¥æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: node-security-reports
          path: |
            frontend/npm-audit-report.json
            frontend/npm-outdated.json
          retention-days: 30

  version-check:
    name: ä¾èµ–ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” æ£€æŸ¥Pythonä¾èµ–å˜åŒ–
        run: |
          cd backend

          echo "## Pythonä¾èµ–å˜åŒ–" >> $GITHUB_STEP_SUMMARY

          # èŽ·å–å˜æ›´çš„æ–‡ä»¶
          git diff origin/${{ github.base_ref }} HEAD -- requirements.txt requirements.lock > /dev/null 2>&1 || true

          # å¦‚æžœrequirements.lockå˜åŒ–äº†ä½†requirements.txtæ²¡å˜ï¼Œç»™å‡ºè­¦å‘Š
          if git diff origin/${{ github.base_ref }} HEAD -- requirements.lock | grep -q .; then
            if ! git diff origin/${{ github.base_ref }} HEAD -- requirements.txt | grep -q .; then
              echo "âš ï¸ **è­¦å‘Š**: requirements.lockå‘ç”Ÿå˜åŒ–ä½†requirements.txtæœªå˜" >> $GITHUB_STEP_SUMMARY
              echo "è¿™å¯èƒ½æ˜¯æ„å¤–æäº¤ï¼Œè¯·ç¡®è®¤æ˜¯å¦ä¸ºé¢„æœŸæ›´æ”¹" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: ðŸ” æ£€æŸ¥Nodeä¾èµ–å˜åŒ–
        run: |
          cd frontend

          echo "## Nodeä¾èµ–å˜åŒ–" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥package-lock.json
          if git diff origin/${{ github.base_ref }} HEAD -- package-lock.json | grep -q .; then
            if ! git diff origin/${{ github.base_ref }} HEAD -- package.json | grep -q .; then
              echo "âš ï¸ **è­¦å‘Š**: package-lock.jsonå‘ç”Ÿå˜åŒ–ä½†package.jsonæœªå˜" >> $GITHUB_STEP_SUMMARY
              echo "è¿™å¯èƒ½æ˜¯æ„å¤–æäº¤ï¼Œè¯·ç¡®è®¤æ˜¯å¦ä¸ºé¢„æœŸæ›´æ”¹" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: ðŸ’¡ å»ºè®®
        run: |
          echo "## ðŸ’¡ ä¾èµ–ç®¡ç†å»ºè®®" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### PythonåŽç«¯" >> $GITHUB_STEP_SUMMARY
          echo "- å®šæœŸè¿è¡Œ: \`pip install -r requirements.txt --upgrade\`" >> $GITHUB_STEP_SUMMARY
          echo "- æ›´æ–°é”å®šæ–‡ä»¶: \`python scripts/lock_requirements.py --update\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Nodeå‰ç«¯" >> $GITHUB_STEP_SUMMARY
          echo "- æ£€æŸ¥æ›´æ–°: \`npm run check:updates\`" >> $GITHUB_STEP_SUMMARY
          echo "- å®‰å…¨å®¡è®¡: \`npm audit\`" >> $GITHUB_STEP_SUMMARY
          echo "- æ›´æ–°ä¾èµ–: \`npm run deps:update\`" >> $GITHUB_STEP_SUMMARY
