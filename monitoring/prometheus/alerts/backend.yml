# Prometheus告警规则
# AI绘本创作平台后端服务告警

groups:
  - name: backend_alerts
    interval: 30s
    rules:
      # ================================
      # 服务可用性告警
      # ================================

      - alert: BackendServiceDown
        expr: up{job="backend"} == 0
        for: 1m
        labels:
          severity: critical
          service: backend
        annotations:
          summary: "后端服务宕机"
          description: "{{ $labels.instance }} 后端服务已宕机超过1分钟"
          runbook_url: "https://docs.example.com/runbooks/backend-down"

      # ================================
      # HTTP错误率告警
      # ================================

      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{job="backend",status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total{job="backend"}[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: warning
          service: backend
        annotations:
          summary: "高HTTP错误率"
          description: "后端服务5xx错误率超过5%（当前: {{ $value | humanizePercentage }}）"

      - alert: CriticalErrorRate
        expr: |
          (
            sum(rate(http_requests_total{job="backend",status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total{job="backend"}[5m]))
          ) > 0.20
        for: 2m
        labels:
          severity: critical
          service: backend
        annotations:
          summary: "严重HTTP错误率"
          description: "后端服务5xx错误率超过20%（当前: {{ $value | humanizePercentage }}）"

      # ================================
      # 响应时间告警
      # ================================

      - alert: HighResponseTime
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket{job="backend"}[5m])) by (le)
          ) > 1
        for: 10m
        labels:
          severity: warning
          service: backend
        annotations:
          summary: "高响应时间（P95）"
          description: "P95响应时间超过1秒（当前: {{ $value | humanizeDuration }}）"

      - alert: CriticalResponseTime
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket{job="backend"}[5m])) by (le)
          ) > 3
        for: 5m
        labels:
          severity: critical
          service: backend
        annotations:
          summary: "严重响应时间（P95）"
          description: "P95响应时间超过3秒（当前: {{ $value | humanizeDuration }}）"

      # ================================
      # 数据库连接告警
      # ================================

      - alert: HighDBConnections
        expr: db_connections_in_use > 80
        for: 10m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "高数据库连接数"
          description: "数据库连接数超过80（当前: {{ $value }}）"

      - alert: CriticalDBConnections
        expr: db_connections_in_use > 90
        for: 5m
        labels:
          severity: critical
          service: database
        annotations:
          summary: "严重数据库连接数"
          description: "数据库连接数超过90（当前: {{ $value }}）"

      # ================================
      # 业务指标告警
      # ================================

      - alert: BookCreationFailureRate
        expr: |
          (
            sum(rate(books_created_total{status="error"}[10m]))
            /
            sum(rate(books_created_total[10m]))
          ) > 0.15
        for: 15m
        labels:
          severity: warning
          service: business
        annotations:
          summary: "绘本创建失败率高"
          description: "绘本创建失败率超过15%（当前: {{ $value | humanizePercentage }}）"

      - alert: StaleBooksInProgress
        expr: books_in_progress > 50
        for: 30m
        labels:
          severity: warning
          service: business
        annotations:
          summary: "进行中的绘本数量过多"
          description: "有超过50个绘本处于创建状态（当前: {{ $value }}）"

      # ================================
      # AI服务告警
      # ================================

      - alert: AIAPIHighFailureRate
        expr: |
          (
            sum(rate(ai_api_calls_total{status="error"}[5m]))
            /
            sum(rate(ai_api_calls_total[5m]))
          ) > 0.10
        for: 10m
        labels:
          severity: warning
          service: ai-api
        annotations:
          summary: "AI API调用失败率高"
          description: "AI API调用失败率超过10%（当前: {{ $value | humanizePercentage }}）"

      - alert: AIAPIHighLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(ai_api_duration_seconds_bucket[5m])) by (le, service)
          ) > 30
        for: 10m
        labels:
          severity: warning
          service: ai-api
        annotations:
          summary: "AI API响应缓慢"
          description: "AI API P95响应时间超过30秒（当前: {{ $value | humanizeDuration }}）"

      # ================================
      # 系统资源告警
      # ================================

      - alert: HighActiveUsers
        expr: active_users_total > 1000
        for: 5m
        labels:
          severity: info
          service: system
        annotations:
          summary: "活跃用户数高"
          description: "活跃用户数超过1000（当前: {{ $value }}）"

      # ================================
      # 缓存告警
      # ================================

      - alert: LowCacheHitRate
        expr: |
          (
            sum(rate(cache_hits_total[5m]))
            /
            (sum(rate(cache_hits_total[5m])) + sum(rate(cache_misses_total[5m])))
          ) < 0.7
        for: 15m
        labels:
          severity: warning
          service: cache
        annotations:
          summary: "缓存命中率低"
          description: "缓存命中率低于70%（当前: {{ $value | humanizePercentage }}）"
